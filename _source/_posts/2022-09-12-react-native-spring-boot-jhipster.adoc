---
layout: blog_post
title: "Integrate React Native and Spring Boot Securely"
author: matt-raible
by: advocate
communities: [mobile,java,javascript]
description: ""
tags: []
tweets:
- ""
image:
type: conversion
github: https://github.com/oktadev/auth0-react-native-jhipster-example
---
:page-liquid:
:toc: macro
:experimental:

React Native is a mobile app framework from Facebook. It allows you to develop apps using React's API and deploy it to iOS and Android with ease. It allows you to quickly refresh the apps when you make changes and generally offers a pleasant experience for web developers.

https://necolas.github.io/react-native-web/[React Native for Web] is a recent addition to the React Native family. It allows you to run your app in a browser and enjoy the developer tools it offers. It's optimized for mobile and uses the same components as React Native so it looks good too!

In this tutorial, I'll show you how to create a React Native application that deploys to web, iOS, and Android. You'll configure it to use OpenID Connect (OIDC) for authentication and use OAuth 2.0 access tokens to talk securely to a Spring Boot API.

// todo: architecture diagram

**Prerequisites:**

* https://adoptopenjdk.net/[Java 11+]
* https://nodejs.org[Node 16+]

toc::[]

== Quick Apps with JHipster

JHipster is a full-stack application generator that uses Spring Boot on the backend and Angular, React, or Vue on the frontend. It started as an open source project in 2013, before any of these frameworks existed. Back then, it used Spring MVC for the backend and AngularJS for the frontend.

Its popularity grew quickly along with its adoption and rise of the aforementioned frameworks. Today, it averages over 100K downloads per month. It even has a healthy budget thanks sponsors and backers via https://opencollective.com/generator-jhipster[Open Collective].

Why am I telling you this? Because JHipster is going to help you build your React Native app _and_ it was used to create the backend in a previous tutorial.

== JHipster blueprints for more power!

A **blueprints** feature was added to JHipster several years ago. It allows you, as a developer, to create a project that overrides the default behavior of JHipster. This has feature has lead to a thriving ecosystem of blueprints, from Kotlin to Micronaut to .NET Core to NestJS to Svelte to Ionic and even React Native.

Today, I'll show you how to use JHipster's React Native blueprint to build a Flickr clone. The backend will be powered by the Spring Boot app created in https://auth0.com/blog/full-stack-java-with-react-spring-boot-and-jhipster/[Full Stack Java with React, Spring Boot, and JHipster] tutorial.

The React Native app's screens will be generated from the same JDL (JHipster Domain Language) file that created the backend entities.

== Build a Photo Gallery with React and Spring Boot

Start by creating a new directory to hold your frontend and backend projects:

[source,shell]
----
take react-native-spring-boot
----

NOTE: `take` is a command that makes a directory and moves into it.

Clone an existing JHipster app into a `backend` directory:

[source,shell]
----
git clone https://github.com/oktadev/auth0-full-stack-java-example.git backend
----

This app is configured to use OIDC for authentication and needs a provider configured to start correctly. To make things easy, there's a pre-configured Keycloak instanced configured with a Docker Compose file. You can start it:

[source,shell]
----
cd backend
docker-compose -f src/main/docker/keycloak.yml up -d
----

// _If you'd rather skip this part, I'll show you how to configure and use Auth0 in a minute._

.Apple Silicon and Keycloak
****
If you're using Apple Silicon (aka M1 or M2), Keycloak will fail to start because its Docker image wasn't available for an M1 when the backend project was created. To fix, run the script below.

[source,shell]
----
VERSION=15.0.2 # Keycloak version
cd /tmp
git clone git@github.com:keycloak/keycloak-containers.git
cd keycloak-containers/server
git checkout $VERSION
docker build -t "jboss/keycloak:${VERSION}" .
docker build -t "quay.io/keycloak/keycloak:${VERSION}" .
----
****

Then, start the backend using `./mvnw` and open your favorite browser to `\http://localhost:8080`. You should be able to upload photos and have them displayed in nice grid. You can click on each photo to zoom in.

image::{% asset_path blog/full-stack-java/photo-gallery.jpg %}[alt=Gallery with Photos,width=800,align=center]

Now, let's create a React Native app that talks to the same API.

== Generate a React Native App

Install React Native JHipster and the Expo CLI:

[source,shell]
----
npm install -g generator-jhipster-react-native expo-cli
----

Create a directory for your React Native app:

[source,shell]
----
take mobile
----

Run the following command to use the React Native blueprint to create an app.

[source,shell]
----
jhipster --blueprints react-native
# or rnhipster
----

When prompted, use the following values:

[cols="1,1"]
|===
|Prompt |Answer

|What do you want to name your React Native application?
|`Flickr2`

|Enter the directory where your JHipster app is located:
|`../backend`

|Do you want to enable end-to-end tests with Detox?
|`No`
|===

Next, generate screens based on the entities in the backend project. Press *a* (for all) when prompted to overwrite files.

[source,shell]
----
rnhipster jdl ../backend/flickr2.jdl
----

In the backend project, change its `src/main/resources/config/application-dev.yml` to allow `\http://localhost:19006` for CORS (cross-origin resource sharing):

[source,yaml]
----
cors:
  allowed-origins: 'http://localhost:19006,...'
----

. Add `\https://auth.expo.io/@mraible/Flickr2` and `exp://192.168.7.222:19000` Login redirect URIs in to the `web_app` client in http://localhost:9080/auth/admin/[Keycloak].

. Hide metadata in add photo screen (`app/modules/entities/photo/photo-edit-screen.js`) when `isNewEntity`
+
[source,jsx]
----
  const metadata = (
    <div>...</div>
  )
  const metadataRows = isNewEntity ? '' : metadata;

  {metadataRows}
----

. To run on emulators, you'll need an https://expo.io/[Expo] account

. In the `backend` directory, run `./mvnw`

. In the `mobile` directory, run `npm start`. Make sure to use `localhost` and not `0.0.0.0` or CORS won't work!

. Web and iOS should work just fine. For Android emulators to communicate with your API and Keycloak, add some port mappings

  adb reverse tcp:8080 tcp:8080 && adb reverse tcp:9080 tcp:9080

. Refresh your app in Simulator using kbd:[{commandKey} + R] or by hitting kbd:[R] twice in Android

== Use Auth0 for Identity

. Log in to your Auth0 account (or https://auth0.com/signup[sign up] if you don't have an account). You should have a unique domain like `dev-xxx.us.auth0.com`.

. Press the *Create Application* button in https://manage.auth0.com/#/applications[Applications section]. Use a name like `JHipster Baby!`, select `Regular Web Applications`, and click *Create*.

. Switch to the *Settings* tab and configure your application settings:
+
- Allowed Callback URLs: `\http://localhost:8080/login/oauth2/code/oidc`
- Allowed Logout URLs: `\http://localhost:8080/`

. Scroll to the bottom and click *Save Changes*.

. In the https://manage.auth0.com/#/roles[roles] section, create new roles named `ROLE_ADMIN` and `ROLE_USER`.

. Create a new user account in the https://manage.auth0.com/#/users[users] section. Click on the *Role* tab to assign the roles you just created to the new account.
+
_Make sure your new user's email is verified before attempting to log in!_

. Next, head to **Actions** > **Flows** and select **Login**. Create a new action named `Add Roles` and use the default trigger and runtime. Change the `onExecutePostLogin` handler to be as follows:
+
[source,js]
----
exports.onExecutePostLogin = async (event, api) => {
  const namespace = 'https://www.jhipster.tech';
  if (event.authorization) {
    api.idToken.setCustomClaim('preferred_username', event.user.email);
    api.idToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
    api.accessToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
  }
}
----
+
This code is adding the user's roles to a custom claim (prefixed with `https://www.jhipster.tech/roles`). This claim is mapped to Spring Security authorities in `SecurityUtils.java`.

. Select **Deploy** and drag the `Add Roles` action to your Login flow.

. Create a `backend/.auth0.env` file and populate it with your Auth0 settings.
+
[source,shell]
----
export SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_OIDC_ISSUER_URI=https://<your-auth0-domain>/
export SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_ID=<your-client-id>
export SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_OIDC_CLIENT_SECRET=<your-client-secret>
export JHIPSTER_SECURITY_OAUTH2_AUDIENCE=https://<your-auth0-domain>/api/v2/
----
+
You can use the default `Auth0 Management API` audience value from the *Applications* > *API* > *API Audience* field. You can also define your own custom API and use the identifier as the API audience.

=== Create a Native OIDC App

. For React Native, create a *Native* app and add the following Allowed Callback URLs:

  http://localhost:19006/,https://auth.expo.io/@mraible/Flickr2,exp://192.168.7.222:19000

. Add to Allowed Logout URLs:

  exp://192.168.7.222:19000, http://localhost:19006

. Set the Allowed Origins (CORS):

  http://localhost:19006

. Copy the client ID to `app/config/app-config.js`.

. Update the `audience` in `app/modules/login/login.utils.ts`:

  audience: 'https://<your-auth0-domain>/api/v2/',
+
While you're in there, set `useExpoAuthProxy` to `false` so full logout is possible.

. Modify the `logoutFromIdp()` method in `login.utils.ts` to add an else condition for Auth0.
+
[source,js]
----
if (endSessionEndpoint) {
  ...
} else if (issuer.includes('auth0.com')) {
  const redirectUri = makeRedirectUri({ useProxy: AppConfig.useExpoAuthProxy });
  await WebBrowser.openAuthSessionAsync(`${issuer}/v2/logout?client_id=${clientId}&returnTo=${redirectUri}`, redirectUri);
}
----
+
NOTE: If this clause already exists, you must be using a newer version with the fix!

. Restart your React Native app and log in with Auth0!
+
----
npm start
----

=== Use Okta for Identity

If you'd like to use Okta as your identity provider, see https://www.jhipster.tech/security/#okta[JHipster's documentation] for how to configure the backend app.

TIP: It's easy with the https://cli.okta.com[Okta CLI]: `okta apps create jhipster`

You'll need to https://www.jhipster.tech/security/#create-a-native-app-for-mobile-on-okta[create a native app on Okta] for React Native too.

https://developer.okta.com/blog/2019/11/14/react-native-login

// JHipster React Native was recently updated to use Expo 46, React Native 0.69.5, and React 18.
// https://twitter.com/mraible/status/1567163914449813510

// {% twitter 1567163914449813510 %}
